<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Iwara 视频免梯播放网站</title>
	<meta name="description" content="一款免梯在线 Iwara 视频播放网站" />
	<meta name="keywords" content="免费视频 在线 视频 Iwara" />
	<link rel="icon"
		href="" />
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		html,
		body,
		input,
		select,
		button {
			outline: none;
			font-family: 'Inter', "Microsoft YaHei", sans-serif;
			font-size: 14px;
		}

		body {
			background: #ffffff;
			color: #333333;
			padding-bottom: calc(env(safe-area-inset-bottom, 0) + 80px);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}

		#github {
			width: 60px;
			height: 50px;
			margin-right: 20px;
			transition: transform 0.3s ease, filter 0.3s ease;
			filter: drop-shadow(0 0 5px rgba(255, 105, 180, 0.5));
		}

		#github:hover {
			transform: scale(1.1) rotate(5deg);
			filter: drop-shadow(0 0 10px rgba(255, 105, 180, 0.8));
		}

		@media (max-width: 768px) {
			#github {
				width: 40px;
				height: 35px;
			}
		}

		#iframeContainer {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			justify-content: center;
			align-items: center;
			background-color: rgba(0, 0, 0, 0.85);
			backdrop-filter: blur(10px);
			z-index: 1000;
			animation: fadeIn 0.3s ease;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		#myVideo {
			width: 90%;
			height: 85%;
			border: none;
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
		}

		button {
			cursor: pointer;
		}

		.page {
			position: relative;
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.wrap {
			flex: 1 0 auto;
			text-align: center;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.meta {
			margin-top: 10vh;
			padding: 40px;
			backdrop-filter: blur(15px);
			-webkit-backdrop-filter: blur(15px);
			width: 90%;
			max-width: 800px;
			opacity: 0;
			transform: translateY(-50px);
			transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		}

		@media (max-width: 768px) {
			.meta {
				margin-top: 5vh;
				padding: 30px 20px;
			}
		}

		.wrap.on .meta {
			opacity: 1;
			transform: translateY(0);
		}

		.title {
			line-height: 1.2em;
			background: linear-gradient(90deg, #ff4665, #ff8a9d);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			font-size: 48px;
			font-weight: 800;
			text-transform: uppercase;
			letter-spacing: 2px;
			text-shadow: 0px 4px 10px rgba(255, 70, 101, 0.2);
		}

		.description {
			margin-top: 15px;
			line-height: 1.5em;
			color: #555555;
			font-size: 18px;
			font-weight: 300;
		}

		.link-area {
			display: flex;
			justify-content: center;
			gap: 15px;
			flex-wrap: wrap;
			margin-top: 40px;
			opacity: 0;
			transition: 0.8s ease 0.2s;
		}

		.wrap.on .link-area {
			opacity: 1;
		}

		.link-area input.form {
			width: 250px;
			height: 45px;
			line-height: normal;
			padding: 0 15px;
			background: rgba(0, 0, 0, 0.05);
			border: 1px solid rgba(0, 0, 0, 0.2);
			border-radius: 8px;
			color: #333333;
			font-size: 16px;
			transition: all 0.3s ease;
		}

		.link-area input.form::placeholder {
			color: rgba(0, 0, 0, 0.5);
		}

		.link-area input.form:focus {
			border-color: #ff4665;
			background: rgba(0, 0, 0, 0.1);
			box-shadow: 0 0 15px rgba(255, 70, 101, 0.3);
		}

		.link-area select {
			width: 100px;
			height: 45px;
			padding: 0 15px;
			background: rgba(0, 0, 0, 0.05);
			border: 1px solid rgba(0, 0, 0, 0.2);
			border-radius: 8px;
			color: #333333;
			font-size: 16px;
			transition: all 0.3s ease;
		}

		.link-area select option {
			background: #ffffff;
			color: #333333;
		}

		.link-area select:focus {
			border-color: #ff4665;
			box-shadow: 0 0 15px rgba(255, 70, 101, 0.3);
		}

		.link-area .btn {
			height: 45px;
			padding: 0 20px;
			border: none;
			border-radius: 8px;
			color: #fff;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			position: relative;
			overflow: hidden;
		}

		.link-area .btn::after {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
			transition: all 0.4s ease;
		}

		.link-area .btn:hover::after {
			left: 100%;
		}

		.link-area .btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
		}

		.link-area .btn:active {
			transform: translateY(1px);
		}

		.btn-play {
			background: linear-gradient(135deg, #ff4665 0%, #ff1c41 100%);
		}

		.btn-hot {
			background: linear-gradient(135deg, #3AB54A 0%, #299c38 100%);
		}

		.btn-save {
			background: linear-gradient(135deg, #CCCC00 0%, #a8a800 100%);
		}

		.btn-share {
			background: linear-gradient(135deg, #33CCFF 0%, #00ace6 100%);
		}

		.btn-token {
			background: linear-gradient(135deg, #FF69B4 0%, #e64a93 100%);
		}

		@media (max-width: 768px) {
			.link-area {
				flex-direction: column;
				align-items: center;
			}

			.input-row {
				display: flex;
				width: 100%;
				justify-content: center;
				gap: 10px;
			}

			.input-row input {
				width: 60%;
			}

			.input-row select {
				width: 35%;
			}

			.link-area .btn {
				width: 100%;
				margin: 0;
			}

			.title {
				font-size: 32px;
			}
		}

		#paginationControls {
			margin: 20px 0;
			text-align: center;
			display: none;
		}

		#paginationControls>div:first-child {
			margin-bottom: 15px;
			color: #333333;
		}

		#paginationControls>div:last-child {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 5px;
			flex-wrap: wrap;
		}

		.page-btn {
			padding: 6px 6px;
			background: linear-gradient(135deg, #ff4665 0%, #ff1c41 100%);
			color: white;
			border: none;
			border-radius: 6px;
			font-weight: 600;
			white-space: nowrap;
			transition: 0.2s;
		}

		.page-btn:disabled {
			background: rgba(0, 0, 0, 0.1);
			color: #999999;
			cursor: not-allowed;
		}

		.page-btn:hover:not(:disabled) {
			transform: translateY(-1px);
			box-shadow: 0 4px 10px rgba(255, 70, 101, 0.3);
		}

		#pageInfo {
			margin: 0 10px;
			font-weight: 600;
			color: #333333;
			white-space: nowrap;
		}

		#pageSizeSelect {
			padding: 5px 10px;
			border: 1px solid rgba(0, 0, 0, 0.2);
			border-radius: 4px;
			background: rgba(0, 0, 0, 0.05);
			color: #333333;
		}

		#pageSizeSelect option {
			background: #ffffff;
			color: #333333;
		}

		.footer {
			position: fixed;
			left: 0;
			right: 0;
			bottom: 0;
			padding: 15px 20px;
			color: #333333;
			text-align: center;
			background: #ffffff;
			backdrop-filter: blur(10px);
			z-index: 999;
			font-size: 13px;
			border-top: 1px solid rgba(0, 0, 0, 0.1);
		}

		.footer a {
			color: #ff8a9d;
			text-decoration: none;
			font-weight: 600;
			transition: color 0.2s;
		}

		.footer a:hover {
			color: #ff4665;
		}

		table {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
		}

		th,
		td {
			padding: 15px;
			text-align: left;
			border-bottom: 1px solid rgba(0, 0, 0, 0.1);
			color: #333333;
		}

		th {
			background-color: rgba(0, 0, 0, 0.05);
			font-weight: 600;
		}

		tr {
			background-color: transparent;
		}

		tr:last-child td {
			border-bottom: none;
		}

		tr:hover td {
			background-color: rgba(0, 0, 0, 0.03);
		}

		#data-table td button {
			padding: 6px 12px;
			font-size: 13px;
			margin-right: 5px;
			border-radius: 4px;
			white-space: nowrap;
			border: none;
			color: #fff;
			cursor: pointer;
		}

		.btn-t-play {
			background: #33CCFF;
		}

		.btn-t-del {
			background: #FF4665;
		}

		#changeButton,
		#saveButton,
		#downButton,
		#closeButton {
			position: absolute;
			top: 15px;
			z-index: 1001;
			border: none;
			padding: 8px 15px;
			border-radius: 6px;
			font-weight: 600;
			color: #fff;
			backdrop-filter: blur(5px);
			transition: all 0.2s;
			white-space: nowrap;
		}

		#changeButton {
			background: rgba(255, 68, 170, 0.8);
			right: 250px;
		}

		#saveButton {
			background: rgba(204, 204, 0, 0.8);
			right: 170px;
		}

		#downButton {
			background: rgba(135, 206, 235, 0.8);
			right: 90px;
		}

		#closeButton {
			background: rgba(255, 0, 0, 0.8);
			right: 15px;
		}

		@media (max-width: 600px) {

			#changeButton,
			#saveButton,
			#downButton,
			#closeButton {
				padding: 6px 10px;
				font-size: 12px;
				top: 10px;
			}

			#changeButton {
				right: 190px;
			}

			#saveButton {
				right: 130px;
			}

			#downButton {
				right: 70px;
			}

			#closeButton {
				right: 10px;
			}
		}

		#changeButton:hover,
		#saveButton:hover,
		#downButton:hover,
		#closeButton:hover {
			transform: translateY(-2px);
			filter: brightness(1.1);
		}

		.swal-modal {
			background: #ffffff;
			border: 1px solid rgba(0, 0, 0, 0.1);
			border-radius: 16px;
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
		}

		.swal-title {
			color: #333333;
		}

		.swal-text {
			color: #555555;
		}

		.swal-button {
			border-radius: 8px;
			font-weight: 600;
		}

		.swal-button--cancel {
			background-color: rgba(0, 0, 0, 0.05);
			color: #333333;
		}

		.swal-button--cancel:hover {
			background-color: rgba(0, 0, 0, 0.1) !important;
		}

		.swal-content__input {
			background: rgba(0, 0, 0, 0.02);
			border: 1px solid rgba(0, 0, 0, 0.2);
			color: #333333;
		}

		.swal-content__input:focus {
			border-color: #ff4665;
			box-shadow: 0 0 10px rgba(255, 70, 101, 0.2);
		}
	</style>
</head>

<body>
	<br />
	<div style="text-align: right;">
		<a href="https://github.com/Iskongkongyo/iwaraVideoProxy" target="_blank"><img id="github"
				src="" /></a>
	</div>
	<!-- 视频播放容器（初始隐藏） -->
	<div id="iframeContainer">
		<button id="changeButton">切换播放源</button>
		<button id="saveButton">收藏</button>
		<button id="downButton">下载</button>
		<button id="closeButton">关闭</button>
		<video id="myVideo" controls>
			<source class="videoSource" src="" type="video/mp4" />
			<source class="videoSource" src="" type="video/webm">
			<source class="videoSource" src="" type="video/ogg"> 您的浏览器不支持视频播放。
		</video>
	</div>
	<!-- 收藏列表隐藏容器（用于 SweetAlert 内容） -->
	<template id="saveVideosTemplate">
		<div class="saveVideos">
			<table id="data-table">
				<thead>
					<tr>
						<th>视频名称</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
			<div id="paginationControls" style="margin:15px 0; text-align:center; display:none;">
				<div style="margin-bottom:10px;">
					<label>每页显示：</label>
					<select id="pageSizeSelect">
						<option value="5">5条</option>
						<option value="10">10条</option>
					</select>
				</div>
				<div>
					<button id="firstPage" class="page-btn">首页</button>
					<button id="prevPage" class="page-btn">上一页</button>
					<span id="pageInfo" style="margin: 0 10px;">第 1 页 / 共 1 页</span>
					<button id="nextPage" class="page-btn">下一页</button>
					<button id="lastPage" class="page-btn">末页</button>
				</div>
			</div>
		</div>
	</template>
	<!-- 新包装：page 容器，作为相对定位父容器 -->
	<div class="page">
		<div class="wrap">
			<div class="meta">
				<h2 class="title">Iwara 视频免梯播放网站</h2>
				<h3 class="description">一款免梯在线 Iwara 视频播放网站</h3>
			</div>
			<div class="link-area">
				<div class="input-row">
					<input id="video" class="form" type="text" placeholder="填写视频ID或粘贴视频链接" />
					<select id="quality">
						<option value="Source">原视频</option>
						<option value="360">360P</option>
						<option value="540" selected>540P</option>
					</select>
				</div>
				<button id="submit" class="btn btn-play">播放视频</button>
				<button id="hot" class="btn btn-hot">随机热门</button>
				<button id="save" class="btn btn-save">打开收藏</button>
				<button id="share" class="btn btn-share">分享视频</button>
				<button id="token" class="btn btn-token">填写令牌</button>
			</div>
			<div class="footer"> Copyright &copy; <a href="https://github.com/Iskongkongyo"
					target="_blank">Iskongkongyo</a> All Rights Reserved </div>
		</div>
	</div>
	<script type="text/javascript">
		(() => {
			// 缓存常用元素
			const q = (sel) => document.querySelector(sel);
			const iframeContainer = q('#iframeContainer');
			const videoElement = q('#myVideo');
			const btnChangeOrigin = q('#changeButton');
			const btnSaveOverlay = q('#saveButton');
			const btnDownload = q('#downButton');
			const btnCloseOverlay = q('#closeButton');
			const inputVideo = q('#video');
			const selectQuality = q('#quality');
			const btnSubmit = q('#submit');
			const btnHot = q('#hot');
			const btnOpenSave = q('#save');
			const btnShare = q('#share');
			const btnToken = q('#token');
			const saveContainer = q('#saveVideos');

			let currentPlayId = '',
				currentVideoName = '',
				currentVideoUrl = '';

			const swalAlert = (text, icon = 'error', button = '关闭') => swal({ text, icon, button });

			const fetchJson = async (url, options = {}) => {
				const res = await fetch(url, options);
				const data = await res.json();
				if (!res.ok) {
					const errorsInfo = {
						"errors.notFound": "该视频未找到或者该视频需填写令牌才能观看!",
						"errors.privateVideo": "该视频被作者设置为私人视频，无法播放!"
					};
					throw errorsInfo[data.message] || '获取视频信息失败';
				}
				return data;
			};

			// 弹窗提示用户遵守法规
			// 判断是否应该显示提示（24小时内不重复提示）
			const promptLastDismissed = localStorage.getItem('promptLastDismissed');
			const shouldShowPrompt = !promptLastDismissed || (Date.now() - parseInt(promptLastDismissed, 10) > 24 * 60 * 60 * 1000);

			if (shouldShowPrompt) {
				// 弹窗提示用户遵守法规
				swal({
					title: '温馨提示',
					text: '本网站免费提供 I站 (Iwara) 视频播放和下载服务！请遵守当地法律法规。若您能访问 I站，请到官网观看更多精彩内容！是否跳转 I站官网？',
					buttons: {
						cancel: {
							text: "暂不跳转",
							value: false,
							visible: true
						},
						confirm: {
							text: "跳转 I站",
							value: true
						}
					}
				}).then(goToIwara => {
					videoElement.pause();
					if (goToIwara) {
						const shareId = new URL(location.href).searchParams.get('id');
						location.replace(shareId ? 'https://www.iwara.tv/video/' + shareId : 'https://www.iwara.tv');
					} else {
						// 用户选择暂不跳转，记录当前时间戳
						localStorage.setItem('promptLastDismissed', Date.now().toString());
					}
				});
			}

			// 页面载入后激活动画效果，若 URL 带有 id 参数则自动播放
			document.addEventListener('DOMContentLoaded', () => {
				setTimeout(() => document.querySelector('.wrap').classList.add('on'), 100);
				setTimeout(async () => {
				const hasValidLocalToken = checkStoredTokenStatusOnLoad();
				await checkBackendTokenStatusOnLoad(hasValidLocalToken);
			}, 1200);
				const idParam = new URLSearchParams(location.search).get('id');
				const qualityParam = new URLSearchParams(location.search).get('quality');
				if (idParam) {
					inputVideo.value = idParam;
					selectQuality.value = qualityParam || selectQuality.value;
					playVideoById();
				}
			});

			// 记录初始窗口高度
			let winHeight = window.innerHeight;

			// 监听窗口大小变化
			window.addEventListener('resize', function () {
				var thisHeight = window.innerHeight;

				if (winHeight - thisHeight > 40) {
					// 键盘弹出
					document.querySelector('.footer').style.display = 'none';
				} else {
					// 键盘收起
					document.querySelector('.footer').style.display = 'block';
				}
			});

			// 回车监听
			document.addEventListener('keypress', event => {
				if (event.key === 'Enter') playVideoById();
			});

			// 绑定按钮事件
			btnSubmit.addEventListener('click', playVideoById);
			btnHot.addEventListener('click', showRandomHotPrompt);
			btnOpenSave.addEventListener('click', () => openFavorites());
			btnShare.addEventListener('click', () => copyLinkToClipboard());
			btnToken.addEventListener('click', () => saveToken());
			btnCloseOverlay.addEventListener('click', () => {
				videoElement.pause();
				videoElement.currentTime = 0;
				iframeContainer.style.display = 'none';
				// 清除旧监听器（避免重复绑定）
				videoElement.onerror = null;
				document.querySelectorAll('.videoSource').forEach(src => src.onerror = null);

				// 清理 YouTube iframe并恢复界面状态
				const ytIframe = document.getElementById('ytPlayer');
				if (ytIframe) {
					ytIframe.src = '';
					ytIframe.style.display = 'none';
				}
				videoElement.style.display = '';
				btnDownload.style.display = '';
				btnChangeOrigin.style.display = '';
			});

			// 输入框 URL 转 ID 解析
			inputVideo.addEventListener('input', () => {
				const url = inputVideo.value;
				if (url.startsWith('https://www.iwara.tv/video/')) {
					const newId = url.replace('https://www.iwara.tv/video/', '').split('/')[0];
					setTimeout(() => {
						inputVideo.value = newId;
					}, 200);
				}
			});

			// 切换视频播放源
			btnChangeOrigin.addEventListener('click', () => {
				// 如果是 YouTube 视频，已经隐藏了这个按钮，但为了安全起见保留判断逻辑可以直接 return
				if (window.currentYoutubeId) {
					return;
				}

				if (!currentVideoUrl || currentVideoUrl === 'undefined') {
					return swalAlert('暂未获取到视频播放链接!', 'error', false);
				}

				const obj = new URL(currentVideoUrl);
				const hostParts = obj.hostname.split('.');
				const currentPrefix = hostParts[0];

				const group1 = ['mikoto', 'hime'];
				const group2 = ['asta', 'acheron', 'firefly', 'hook', 'hanya', 'camellya'];

				let availableOptions = [];
				if (group1.includes(currentPrefix)) {
					availableOptions = group1.filter(p => p !== currentPrefix);
				} else if (group2.includes(currentPrefix)) {
					availableOptions = group2.filter(p => p !== currentPrefix);
				} else {
					// Fallback if the prefix doesn't match known groups but follows the same pattern
					availableOptions = group2; // arbitrary default fallback
				}

				if (availableOptions.length === 0) {
					return swalAlert('没有可用的其他源', 'error', false);
				}

				const selectBox = document.createElement("select");
				selectBox.className = "swal-content__input";
				selectBox.style.width = "100%";
				selectBox.style.padding = "10px";
				selectBox.style.marginTop = "15px";
				selectBox.style.borderRadius = "8px";

				availableOptions.forEach(opt => {
					const option = document.createElement("option");
					option.value = opt;
					option.text = opt;
					selectBox.appendChild(option);
				});

				swal({
					title: "切换播放源",
					text: "当前源: " + currentPrefix + "。请选择新的播放源：",
					content: selectBox,
					buttons: {
						cancel: {
							text: "取消",
							value: false,
							visible: true
						},
						confirm: {
							text: "确认",
							value: true
						}
					}
				}).then((isConfirm) => {
					if (!isConfirm) return;

					const selectedValue = selectBox.value;
					if (!selectedValue) return;

					hostParts[0] = selectedValue;
					obj.hostname = hostParts.join('.');
					currentVideoUrl = obj.toString();

					swalAlert('已切换到 ' + selectedValue + ' 服务器播放视频!', 'success', false);

					const finalUrl = '/view?url=' + encodeURIComponent(currentVideoUrl);

					// 播放视频
					videoElement.pause();
					videoElement.currentTime = 0;
					iframeContainer.style.display = 'none';
					iframeContainer.style.display = 'flex';
					const videoSource = document.querySelector('.videoSource');
					videoSource.src = finalUrl + '#t=0'; // 设置 video 源链接
					videoElement.load(); // 加载视频
				});
			});

			// 收藏按钮（覆盖当前视频）
			btnSaveOverlay.addEventListener('click', () => {
				let data = JSON.parse(localStorage.getItem('save') || '{}');
				data[currentPlayId] = currentVideoName;
				localStorage.setItem('save', JSON.stringify(data));
				swalAlert('收藏成功！', 'success', false);
			});

			// 下载当前视频
			btnDownload.addEventListener('click', () => {
				const videoSource = document.querySelector('.videoSource');
				if (!videoSource || !videoSource.src) return;
				const a = document.createElement('a');
				a.href = videoSource.src;
				a.download = currentVideoName || 'video.mp4';
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
			});

			// 获取油管视频ID
			function getYouTubeId(embedUrl) {
				if (!embedUrl) return null;
				const s = embedUrl.replaceAll("&amp;", "&");

				let u;
				try { u = new URL(s); } catch { return null; }

				const host = u.hostname.replace(/^www\./, "").replace(/^m\./, "");

				if (host === "youtu.be") return u.pathname.split("/").filter(Boolean)[0] || null;

				if (host === "youtube.com") {
					if (u.pathname === "/watch") return u.searchParams.get("v");
					const parts = u.pathname.split("/").filter(Boolean);
					if (parts[0] === "embed" || parts[0] === "shorts") return parts[1] || null;
				}
				return null;
			}

			// 播放视频逻辑
			async function playVideoById() {
				const id = inputVideo.value.trim() || 'Hvfo6PVnB9mnsD';
				const validId = /^[0-9a-zA-Z]{9,}$/;
				if (!id) {
					inputVideo.value = '';
					return;
				}
				if (!validId.test(id)) {
					swalAlert('视频 ID 格式不正确！');
					inputVideo.value = '';
					return;
				}
				const quality = selectQuality.value;
				currentPlayId = id;

				// 获取视频信息
				try {
					const data = await fetchJson('/video/' + id, {
						headers: {
							CustomizedToken: localStorage.getItem('token') ? 'Bearer ' + localStorage.getItem('token') : ''
						}
					});

					// 检查 data.file 是否存在
					if (!data.file) {
						// data.file 为 null，尝试解析 embedUrl
						if (data.embedUrl) {
							const ytVideoId = getYouTubeId(data.embedUrl);
							if (ytVideoId) {
								currentVideoName = data.title || 'YouTube Video';

								// 记录当前是 YouTube 视频
								window.currentYoutubeId = ytVideoId;
								// 默认使用用户上次选择的源，或者官方源
								const ytSource = localStorage.getItem('ytSource') || 'https://www.youtube.com/embed/';
								const ytEmbedSrc = ytSource + ytVideoId + (ytSource.includes('?') ? '&' : '?') + 'autoplay=1';

								// 使用 iframe 播放 YouTube 视频
								videoElement.pause();
								videoElement.style.display = 'none';
								// 隐藏下载按钮 (YouTube无法直接下载)
								btnDownload.style.display = 'none';
								btnChangeOrigin.style.display = 'none'; // 隐藏切换源按钮

								let ytIframe = document.getElementById('ytPlayer');
								if (!ytIframe) {
									ytIframe = document.createElement('iframe');
									ytIframe.id = 'ytPlayer';
									ytIframe.style.width = '90%';
									ytIframe.style.height = '85%';
									ytIframe.style.border = 'none';
									ytIframe.style.borderRadius = '12px';
									ytIframe.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.5)';
									ytIframe.setAttribute('allowfullscreen', '');
									ytIframe.setAttribute('allow', 'autoplay; encrypted-media');
									iframeContainer.insertBefore(ytIframe, iframeContainer.firstChild);
								}
								ytIframe.src = ytEmbedSrc;
								ytIframe.style.display = 'block';
								iframeContainer.style.display = 'flex';

								// 提示用户需要网络支持
								swal({
									title: "播放提示",
									text: "即将播放 YouTube 视频，请确保你的网络环境可以直接访问 YouTube，否则将无法正常加载和播放。",
									icon: "info",
									button: "我知道了"
								});
								return;
							}
						}
						// 既没有 file 也没有有效的 embedUrl
						throw '该视频暂无可用播放资源（file 为空且无有效的 embedUrl）';
					}

					// 清除 YouTube 状态
					window.currentYoutubeId = null;

					currentVideoName = data.title + '.' + data.file.mime.replace('video/', '');
					// NTR 标题提示
					if (/NTR/i.test(data.title)) {
						let pauseIntv = setInterval(() => videoElement.pause(), 300);
						const proceed = await swal({
							title: '温馨提示',
							text: '检测到视频标题 ' + data.title + ' 中包含 NTR 关键字，是否继续播放？',
							buttons: {
								cancel: {
									text: "播放",
									value: false,
									visible: true
								},
								confirm: {
									text: "不播放",
									value: true
								}
							}
						});
						clearInterval(pauseIntv);
						if (proceed) {
							btnCloseOverlay.click();
							return;
						}
					}

					// 计算播放链接
					const fileUrl = new URL(data.fileUrl);
					const filehash = fileUrl.searchParams.get('hash');
					const fileExpires = fileUrl.searchParams.get('expires');
					const inputString = data.file.id + '_' + fileExpires + '_mSvL05GfEmeEmsEYfGCnVpEjYgTJraJN';

					// 生成 SHA-1
					const hashHex = await (async function (str) {
						if (window.crypto && crypto.subtle) {
							const hashBuf = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(str));
							return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
						}
						function encodeUTF8(s) {
							let r = [];
							for (let i = 0; i < s.length; i++) {
								let c = s.charCodeAt(i);
								if (c < 0x80) r.push(c);
								else if (c < 0x800) r.push(0xc0 | (c >> 6), 0x80 | (c & 0x3f));
								else if (c < 0xd800 || c >= 0xe000) r.push(0xe0 | (c >> 12), 0x80 | ((c >> 6) & 0x3f), 0x80 | (c & 0x3f));
								else {
									i++;
									c = 0x10000 + (((c & 0x3ff) << 10) | (s.charCodeAt(i) & 0x3ff));
									r.push(0xf0 | (c >> 18), 0x80 | ((c >> 12) & 0x3f), 0x80 | ((c >> 6) & 0x3f), 0x80 | (c & 0x3f));
								}
							}
							return r;
						}
						function rol(n, c) { return (n << c) | (n >>> (32 - c)); }
						let data = encodeUTF8(str);
						let l = ((data.length + 8) >>> 6 << 4) + 16, s = new Uint32Array(l);
						for (let i = 0; i < data.length; i++) s[i >> 2] |= data[i] << (24 - (i & 3) * 8);
						s[data.length >> 2] |= 0x80 << (24 - (data.length & 3) * 8);
						s[l - 1] = data.length * 8;
						let w = new Uint32Array(80), h = [1732584193, -271733879, -1732584194, 271733878, -1009589776];
						for (let i = 0; i < l; i += 16) {
							let a = h[0], b = h[1], c = h[2], d = h[3], e = h[4];
							for (let j = 0; j < 80; j++) {
								w[j] = j < 16 ? s[i + j] : rol(w[j - 3] ^ w[j - 8] ^ w[j - 14] ^ w[j - 16], 1);
								let f = j < 20 ? (b & c) | (~b & d) : j < 40 ? b ^ c ^ d : j < 60 ? (b & c) | (b & d) | (c & d) : b ^ c ^ d;
								let k = j < 20 ? 1518500249 : j < 40 ? 1859775393 : j < 60 ? -1894007588 : -899497514;
								let temp = (rol(a, 5) + f + e + k + w[j]) | 0;
								e = d; d = c; c = rol(b, 30); b = a; a = temp;
							}
							h[0] = (h[0] + a) | 0; h[1] = (h[1] + b) | 0; h[2] = (h[2] + c) | 0; h[3] = (h[3] + d) | 0; h[4] = (h[4] + e) | 0;
						}
						return h.map(x => ('00000000' + (x >>> 0).toString(16)).slice(-8)).join('');
					})(inputString);

					// 获取实际播放链接
					const res2 = await fetch(fileUrl.pathname + '?expires=' + fileExpires + '&hash=' + filehash +
						'&download=' + encodeURIComponent('Iwara - ' + data.title + ' [' + data.id + '].' + data
							.file.mime.replace('video/', '')), {
						headers: {
							'X-Version': hashHex
						}
					});
					if (!res2.ok) {
						throw '获取播放资源失败';
					}
					const data2 = await res2.json();
					currentVideoUrl = 'https:' + getVideoUrlByQuality(data2, quality);
					const finalUrl = '/view?url=' + encodeURIComponent(currentVideoUrl);

					// 播放视频
					videoElement.pause();
					videoElement.currentTime = 0;
					iframeContainer.style.display = 'none';
					iframeContainer.style.display = 'flex';
					const videoSource = document.querySelector('.videoSource');
					videoSource.src = finalUrl + '#t=0'; // 设置 video 源链接
					// 清除旧监听器（避免重复绑定）
					videoElement.onerror = null;
					document.querySelectorAll('.videoSource').forEach(src => src.onerror = null);
					// 绑定监听器
					bindVideoErrorHandlers();
					videoElement.load(); // 加载视频

				} catch (err) {
					swalAlert('出现错误：' + err);
				}
			}

			// 监听视频播放失败事件
			function bindVideoErrorHandlers() {
				const handleVideoError = () => {
					swal({
						title: '播放失败',
						text: '媒体无法加载，可能是服务器或网络故障，或者格式不被支持！是否重新请求视频？',
						buttons: {
							cancel: {
								text: "关闭",
								value: false,
								visible: true
							},
							confirm: {
								text: "重新请求",
								value: true
							}
						}
					}).then(req => {
						videoElement.pause();
						if (req) playVideoById();
					});
				};

				videoElement.addEventListener('error', handleVideoError);
				document.querySelectorAll('.videoSource').forEach(src => {
					src.addEventListener('error', handleVideoError);
				});
			}

			// 根据清晰度从播放列表中选取链接
			function getVideoUrlByQuality(list, quality) {
				const found = list.find(item => item.name === quality);
				return (found || list[0]).src.view;
			}

			// 显示随机热门选择
			function showRandomHotPrompt() {
				swal({
					text: '随机热门视频分为普通和 R18 内容，您要随机播放哪种内容？',
					icon: 'info',
					buttons: {
						cancel: {
							text: "关闭",
							value: false
						},
						r18: {
							text: "R18",
							value: 'R18'
						},
						general: {
							text: "普通",
							value: 'General'
						}
					}
				}).then(choice => {
					if (!choice) return;
					let keyInfo = choice === 'R18' ? 'hots' : 'generalHots';
					let keyTs = choice === 'R18' ? 'ts' : 'generalTs';
					let rating = choice === 'R18' ? 'ecchi' : 'general';
					const cache = localStorage.getItem(keyInfo);
					const timestamp = parseInt(localStorage.getItem(keyTs) || '0');
					if (cache && !isExpired(timestamp)) {
						const list = JSON.parse(cache);
						inputVideo.value = list[getRandomInt(0, list.length - 1)].id;
						playVideoById();
					} else {
						fetchJson("/videos?rating=" + rating + "&sort=trending&limit=24")
							.then(data => {
								const results = data.results || [];
								localStorage.setItem(keyInfo, JSON.stringify(results));
								localStorage.setItem(keyTs, Date.now().toString());
								if (results.length) {
									inputVideo.value = results[getRandomInt(0, results.length - 1)].id;
									playVideoById();
								}
							})
							.catch(err => swalAlert('出现错误：' + err));
					}
				});
			}

			// 打开收藏列表（使用 template 克隆，不再移除原 DOM）
			function openFavorites() {
				const data = JSON.parse(localStorage.getItem('save') || '{}');
				const entries = Object.entries(data);
				const reversedEntries = entries.reverse();
				const reversedData = Object.fromEntries(reversedEntries);

				// 克隆模板内容
				const template = document.getElementById('saveVideosTemplate');
				const saveContainer = template.content.firstElementChild.cloneNode(true);

				const saveTableBody = saveContainer.querySelector('tbody');
				const pageSizeSelect = saveContainer.querySelector('#pageSizeSelect');
				const firstPageBtn = saveContainer.querySelector('#firstPage');
				const prevPageBtn = saveContainer.querySelector('#prevPage');
				const nextPageBtn = saveContainer.querySelector('#nextPage');
				const lastPageBtn = saveContainer.querySelector('#lastPage');
				const pageInfo = saveContainer.querySelector('#pageInfo');
				const paginationControls = saveContainer.querySelector('#paginationControls');

				let currentPage = 1;
				let pageSize = 5;
				let totalPages = 1;

				// 计算总页数
				function calculateTotalPages() {
					const totalItems = Object.keys(reversedData).length;
					totalPages = Math.ceil(totalItems / pageSize);
					if (totalPages === 0) totalPages = 1;
				}

				// 渲染当前页
				function renderCurrentPage() {
					saveTableBody.innerHTML = '';

					const dataArray = Object.entries(reversedData);
					const startIndex = (currentPage - 1) * pageSize;
					const endIndex = Math.min(startIndex + pageSize, dataArray.length);
					const cur = dataArray.slice(startIndex, endIndex);

					cur.forEach(([id, name]) => {
						const tr = document.createElement('tr');

						const td1 = document.createElement('td');
						td1.textContent = name;
						td1.dataset.id = id;

						const td2 = document.createElement('td');

						const btnPlay = document.createElement('button');
						btnPlay.textContent = '播放';
						btnPlay.className = 'btn-t-play';

						const btnDel = document.createElement('button');
						btnDel.textContent = '删除';
						btnDel.className = 'btn-t-del';

						td2.appendChild(btnPlay);
						td2.appendChild(btnDel);

						tr.appendChild(td1);
						tr.appendChild(td2);
						saveTableBody.appendChild(tr);

						// 点击播放
						btnPlay.onclick = () => {
							inputVideo.value = id;
							swal.close();
							playVideoById();
						};

						// 点击删除
						btnDel.onclick = () => {
							if (confirm('确认删除 ' + name + ' 吗？')) {
								delete reversedData[id];
								const entries = Object.entries(reversedData);
								const reversedEntries = entries.reverse();
								const data = Object.fromEntries(reversedEntries);
								localStorage.setItem('save', JSON.stringify(data));
								calculateTotalPages();
								if (currentPage > totalPages) currentPage = totalPages;
								renderCurrentPage();
								updateControls();
							}
						};
					});

					// 空提示
					if (cur.length === 0) {
						const tr = document.createElement('tr');
						const td = document.createElement('td');
						td.colSpan = 2;
						td.textContent = '暂无收藏视频';
						td.style.textAlign = 'center';
						td.style.color = '#999';
						tr.appendChild(td);
						saveTableBody.appendChild(tr);
					}
				}

				// 更新分页控件
				function updateControls() {
					pageInfo.textContent = '第 ' + currentPage + ' 页 / 共 ' + totalPages + ' 页';

					firstPageBtn.disabled = currentPage === 1;
					prevPageBtn.disabled = currentPage === 1;
					nextPageBtn.disabled = currentPage === totalPages;
					lastPageBtn.disabled = currentPage === totalPages;

					paginationControls.style.display = totalPages > 1 ? 'block' : 'none';
				}

				// 分页按钮
				firstPageBtn.onclick = () => {
					currentPage = 1;
					renderCurrentPage();
					updateControls();
				};

				prevPageBtn.onclick = () => {
					if (currentPage > 1) currentPage--;
					renderCurrentPage();
					updateControls();
				};

				nextPageBtn.onclick = () => {
					if (currentPage < totalPages) currentPage++;
					renderCurrentPage();
					updateControls();
				};

				lastPageBtn.onclick = () => {
					currentPage = totalPages;
					renderCurrentPage();
					updateControls();
				};

				// 每页数量改变
				pageSizeSelect.onchange = () => {
					pageSize = parseInt(pageSizeSelect.value);
					currentPage = 1;
					calculateTotalPages();
					renderCurrentPage();
					updateControls();
				};

				// 点击行复制链接
				saveTableBody.addEventListener('click', e => {
					const tr = e.target.closest('tr');
					if (tr && !e.target.matches('button')) {
						const td = tr.querySelector('td');
						if (td && td.dataset.id) {
							copyLinkToClipboard('https://www.iwara.tv/video/' + td.dataset.id);
						}
					}
				});

				// 初始化
				calculateTotalPages();
				renderCurrentPage();
				updateControls();

				// SweetAlert 弹窗
				swal({
					title: '我的收藏',
					content: saveContainer,
					buttons: {
						clear: {
							text: "清空收藏",
							value: 'clear'
						},
						export: {
							text: "导出收藏",
							value: 'export'
						},
						import: {
							text: "导入收藏",
							value: 'import'
						},
						close: {
							text: "关闭",
							value: null
						}
					}
				}).then(act => {
					if (act === 'clear') {
						swal({
							title: '提示',
							text: '清空收藏不可恢复，是否确认？',
							icon: 'warning',
							buttons: ['取消', '清空']
						}).then(ok => {
							if (ok) {
								localStorage.removeItem('save');
								openFavorites();
							}
						});
					} else if (act === 'export') {
						exportFavorites();
					} else if (act === 'import') {
						importFavorites().then(() => openFavorites());
					}
				});
			}

			// 检查 JWT Token 是否有效（仅本地解析，不验证签名）
			function isJwtValid(token) {
				try {
					if (typeof token !== 'string' || token.trim() === '') {
						return false; // 空或非字符串
					}

					const parts = token.split('.');
					if (parts.length !== 3) {
						return false; // JWT 必须由三部分组成
					}

					// 解码 payload（Base64URL 转换）
					const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));

					// 检查 exp（过期时间，单位秒）
					if (!payload.exp || typeof payload.exp !== 'number') {
						return false; // 没有过期时间
					}

					const now = Math.floor(Date.now() / 1000); // 当前时间（秒）
					return payload.exp > now; // true 表示未过期
				} catch (err) {
					console.error('Token 解析失败:', err);
					return false;
				}
			}

			// 页面访问时自动检查本地 Token 是否过期
			function checkStoredTokenStatusOnLoad() {
				const token = localStorage.getItem('token');
				if (!token) return false;

				if (!isJwtValid(token)) {
					localStorage.removeItem('token');
					swal({
						title: '令牌已失效',
						text: '检测到你之前保存的 Iwara 令牌已过期或无效，已自动清除，请重新填写令牌。',
						icon: 'warning',
						button: '知道了'
					});
					return false;
				}

				return true;
			}

			// 页面访问时检查后端默认 Token 状态（若后端未配置则按 Retry-After 节流重试）
			async function checkBackendTokenStatusOnLoad(hasValidLocalToken = false) {
				const nextCheckKey = 'backendTokenStatusNextCheckAt';
				const now = Date.now();
				const nextCheckAt = parseInt(localStorage.getItem(nextCheckKey) || '0', 10);
				if (nextCheckAt && now < nextCheckAt) return;

				try {
					const res = await fetch('/token-status', { headers: { Accept: 'application/json' } });
					if (res.status === 204) {
						const retryAfter = parseInt(res.headers.get('Retry-After') || '0', 10);
						if (retryAfter > 0) {
							localStorage.setItem(nextCheckKey, (Date.now() + retryAfter * 1000).toString());
						} else {
							localStorage.removeItem(nextCheckKey);
						}
						return;
					}
					if (!res.ok) return;
					const data = await res.json().catch(() => ({}));
					if (data && data.code === 'backend_token_expired') {
						localStorage.removeItem(nextCheckKey);
						if (!hasValidLocalToken) {
							swal({
								title: '令牌已失效',
								text: data.message || '后端设置的token已过期！',
								icon: 'warning',
								button: '知道了'
							});
						}
					}
				} catch (err) {
					// 后端状态检测失败时静默处理，避免影响正常使用
				}
			}

			// 保存Token
			function saveToken() {
				swal({
					"title": "令牌获取方法",
					"text": "在Iwara官网首页，PC端按“F12”，在弹出的窗口中选择“控制台”，输入“localStorage.getItem('token')”后按回车，把输出的内容复制到下方点击确定即可！",
					content: "input",
					button: "确定"
				})
					.then((value) => {

						if (isJwtValid(value)) {
							localStorage.setItem('token', value);
							swal({
								text: "令牌填写成功！",
								icon: "success",
								button: "确定"
							});
						} else {
							swal({
								text: "令牌格式有误或已过期！",
								icon: "error",
								button: "确定"
							});
						}

					});
			}

			// 导出收藏
			function exportFavorites() {
				const data = localStorage.getItem('save');
				if (data) {
					const blob = new Blob([data], {
						type: 'application/json'
					});
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'Iwara收藏视频.json';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				}
			}

			// 导入收藏（返回Promise）
			function importFavorites() {
				return new Promise((resolve) => {
					const input = document.createElement('input');
					input.type = 'file';
					input.accept = 'application/json';
					input.style.display = 'none';
					document.body.appendChild(input);

					input.addEventListener('change', () => {
						if (!input.files[0]) {
							resolve();
							return;
						}

						const reader = new FileReader();
						reader.readAsText(input.files[0]);
						reader.onload = () => {
							const imported = reader.result;
							if (localStorage.getItem('save')) {
								swal({
									text: '已有收藏内容，导入将覆盖旧数据，是否继续？',
									icon: 'warning',
									buttons: {
										cancel: '取消',
										ok: '确定'
									}
								}).then(ok => {
									if (ok) {
										localStorage.setItem('save', imported);
									}
									resolve();
								});
							} else {
								localStorage.setItem('save', imported);
								resolve();
							}
						};

						reader.onerror = () => {
							swal({
								text: '文件读取失败',
								icon: 'error'
							});
							resolve();
						};
					}, {
						once: true
					});

					input.click();
					// 如果用户取消选择文件，也需要resolve
					input.addEventListener('cancel', () => {
						setTimeout(resolve, 100);
					}, {
						once: true
					});
				});
			}

			// 复制链接到剪切板
			async function copyLinkToClipboard(url = null) {
				try {
					const link = url || (() => {
						const u = new URL(location.origin);
						u.searchParams.set('id', inputVideo.value.trim() || 'Hvfo6PVnB9mnsD');
						u.searchParams.set('quality', selectQuality.value);
						return u.href;
					})();
					await navigator.clipboard.writeText(link);
					swal("链接已复制到剪切板！", {
						icon: "success",
						buttons: false,
						timer: 2000
					});
				} catch (err) {
					swal({
						text: '复制失败：' + err,
						icon: 'error',
						button: '关闭'
					});
				}
			}

			// 判断时间是否超过一天
			function isExpired(timestamp) {
				return Date.now() - timestamp > 24 * 60 * 60 * 1000;
			}

			// 获取 [min, max] 区间随机整数
			const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

		})();
	</script>
</body>

</html>